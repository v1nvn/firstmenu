name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Run tests
        run: make pulse

      - name: Build Release
        run: |
          xcodebuild archive \
            -project firstmenu.xcodeproj \
            -scheme firstmenu \
            -archivePath build/firstmenu.xcarchive \
            -configuration Release

      - name: Export App
        run: |
          cd build
          if [ -d "firstmenu.app" ]; then
            rm -rf firstmenu.app
          fi
          cp -R firstmenu.xcarchive/Products/Applications/firstmenu.app .

      - name: Create DMG
        run: |
          hdiutil create \
            -volname "firstmenu" \
            -srcfolder build/firstmenu.app \
            -ov -format UDZO \
            build/firstmenu.dmg

      - name: Generate Checksums
        run: |
          cd build
          shasum -a 256 firstmenu.dmg > checksums.txt
          cat checksums.txt

      - name: Get Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          if [ -f "CHANGELOG.md" ]; then
            # Extract notes for this version from CHANGELOG
            sed -n "/## \[$VERSION\]/,/^## /p" CHANGELOG.md | head -n -1 > release_notes.txt
          else
            echo "See docs/release/version-strategy.md for release notes." > release_notes.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.txt
          files: |
            build/firstmenu.dmg
            build/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    name: Update Homebrew Formula
    runs-on: macos-15
    needs: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Homebrew Formula
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cat > Formula/firstmenu.rb << 'EOF'
          class Firstmenu < Formula
            desc "Lightweight macOS menu bar system monitor"
            homepage "https://github.com/v1nit/firstmenu"
            url "https://github.com/v1nit/firstmenu/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "$(curl -L -s https://github.com/v1nit/firstmenu/archive/refs/tags/v${VERSION}.tar.gz | shasum -a 256 | awk '{print $1}')"

            depends_on :macos

            def install
              system "swift", "build", "--disable-sandbox", "-c", "release"
              bin.install ".build/release/firstmenu"
            end

            test do
              system "#{bin}/firstmenu", "--version"
            end
          end
          EOF

      - name: Upload Formula
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: Formula/firstmenu.rb
